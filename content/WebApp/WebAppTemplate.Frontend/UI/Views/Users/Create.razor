@page "/users/create"

@using LucideBlazor
@using ShadcnBlazor.Buttons
@using ShadcnBlazor.Cards
@using ShadcnBlazor.Extras.Forms
@using ShadcnBlazor.Extras.Toasts
@using ShadcnBlazor.Fields
@using ShadcnBlazor.Inputs
@using WebAppTemplate.Shared.Http.Requests.Users

@inject HttpClient HttpClient
@inject NavigationManager Navigation
@inject ToastService ToastService

<EnhancedEditForm Model="Request" OnValidSubmit="OnSubmitAsync" Context="formContext">

    <div class="flex flex-row justify-between">
        <div class="flex flex-col">
            <h1 class="text-xl font-semibold">Create user</h1>
            <div class="text-muted-foreground">
                Create a new user
            </div>
        </div>
        <div class="flex flex-row gap-x-1.5">
            <Button Variant="ButtonVariant.Secondary">
                <Slot>
                    <a href="/users" @attributes="context">
                        <ChevronLeftIcon/>
                        Back
                    </a>
                </Slot>
            </Button>
            <SubmitButton>
                <CheckIcon/>
                Continue
            </SubmitButton>
        </div>
    </div>

    <div class="mt-8">
        <Card>
            <CardContent>
                <DataAnnotationsValidator/>

                <FieldGroup>
                    <FormValidationSummary/>

                    <FieldSet>
                        <Field>
                            <FieldLabel for="email">Email</FieldLabel>
                            <TextInputField
                                @bind-Value="Request.Email"
                                id="email"
                                Type="email"
                                placeholder="m@example.com"/>
                        </Field>

                        <Field>
                            <FieldLabel for="username">Username</FieldLabel>
                            <TextInputField
                                @bind-Value="Request.Username"
                                id="username"
                                Type="text"
                                placeholder="example_user"/>
                        </Field>
                    </FieldSet>
                </FieldGroup>
            </CardContent>
        </Card>
    </div>

</EnhancedEditForm>

@code
{
    private CreateUserDto Request = new();

    private async Task<bool> OnSubmitAsync(EditContext context, ValidationMessageStore store)
    {
        var response = await HttpClient.PostAsJsonAsync(
            "/api/users",
            Request,
            Constants.SerializerOptions
        );

        if (!response.IsSuccessStatusCode)
        {
            
            
            return false;
        }

        await ToastService.SuccessAsync(
            "User Creation",
            $"Successfully created user {Request.Username}"
        );

        Navigation.NavigateTo("/users");
        return true;
    }
}